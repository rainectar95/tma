<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>üåØ –ó–∞–∫–∞–∑ –õ–∞–≤–∞—à–∞ –∏ –ü—Ä–æ–¥—É–∫—Ç–æ–≤</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ... (–°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... */
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f4f4f4);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-link: var(--tg-theme-link-color, #2481cc);
            --tg-button: var(--tg-theme-button-color, #50a8eb);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #777777);
        }
        body { 
            font-family: sans-serif; 
            padding: 10px; 
            background-color: var(--tg-bg); 
            color: var(--tg-text); 
            margin: 0;
        }
        h1, h2 { color: var(--tg-text); margin: 15px 0 10px 0; border-bottom: 1px solid var(--tg-secondary-bg); padding-bottom: 5px; }
        .product-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; padding: 5px 0; }
        .product-card { background-color: var(--tg-secondary-bg); padding: 10px; border-radius: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .product-img { width: 100%; height: 100px; object-fit: cover; border-radius: 4px; margin-bottom: 5px; }
        .product-price { font-weight: bold; color: var(--tg-link); margin-bottom: 8px; font-size: 16px; }
        .add-btn, .order-btn { background-color: var(--tg-button); color: var(--tg-button-text); border: none; padding: 8px 0; width: 100%; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed var(--tg-hint); }
        .cart-details { flex-grow: 1; padding-right: 15px; }
        .cart-name { font-weight: 600; }
        .cart-controls { display: flex; align-items: center; gap: 5px; }
        .qty-btn { background-color: var(--tg-secondary-bg); color: var(--tg-text); border: 1px solid var(--tg-hint); width: 30px; height: 30px; border-radius: 50%; font-size: 18px; line-height: 1; cursor: pointer; }
        .item-quantity { font-weight: bold; width: 25px; text-align: center; }
        .total-summary { margin-top: 20px; padding: 15px; background-color: var(--tg-secondary-bg); border-radius: 8px; }
        .total-summary div { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input[type="text"], textarea, select { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid var(--tg-secondary-bg); 
            border-radius: 6px; 
            box-sizing: border-box; 
            background-color: var(--tg-bg);
            color: var(--tg-text);
        }
    </style>
</head>
<body>
    
    <div id="catalog-view" style="display: block;">
        <h1>üåØ –ö–∞—Ç–∞–ª–æ–≥ –ü—Ä–æ–¥—É–∫—Ç–æ–≤</h1>
        <div id="product-list" class="product-list">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞...</div>
        </div>
    </div>
    
    <div id="cart-view" style="display: none;">
        <button class="order-btn" style="background-color: transparent; color: var(--tg-link);" onclick="showView('catalog-view')">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–∞–ª–æ–≥—É</button>
        <h2>üõí –í–∞—à–∞ –ö–æ—Ä–∑–∏–Ω–∞</h2>
        <div id="cart-items-list"></div>
        <div id="cart-empty-message" style="text-align: center; color: var(--tg-hint); margin-top: 20px; display: none;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.</div>
        <div id="cart-summary" class="total-summary"></div>
        <div style="margin-top: 20px;">
            <button id="checkout-btn" class="order-btn" style="padding: 15px;" onclick="showCheckoutForm()">‚û°Ô∏è –û—Ñ–æ—Ä–º–∏—Ç—å –ó–∞–∫–∞–∑</button>
        </div>
    </div>
    
    <div id="checkout-view" style="display: none;">
        <button class="order-btn" style="background-color: transparent; color: var(--tg-link);" onclick="showView('cart-view')">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –∫–æ—Ä–∑–∏–Ω–µ</button>
        <h2>üìÑ –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h2>
        
        <div class="total-summary" id="checkout-summary"></div>
        
        <div class="form-group">
            <label for="deliveryType">–¢–∏–ø –ø–æ–ª—É—á–µ–Ω–∏—è:</label>
            <select id="deliveryType" onchange="toggleAddressField()" style="padding: 10px;">
                <option value="–î–æ—Å—Ç–∞–≤–∫–∞">–î–æ—Å—Ç–∞–≤–∫–∞ (–ö—É—Ä—å–µ—Ä–æ–º)</option>
                <option value="–°–∞–º–æ–≤—ã–≤–æ–∑">–°–∞–º–æ–≤—ã–≤–æ–∑ (–ò–∑ —Ü–µ—Ö–∞)</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="name">–í–∞—à–µ –ò–º—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
            <input type="text" id="name" required>
        </div>
        
        <div class="form-group">
            <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
            <input type="text" id="phone" required placeholder="+7 (XXX) XXX XX XX">
        </div>
        
        <div class="form-group" id="address-group">
            <label for="address">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
            <input type="text" id="address" required placeholder="–£–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞">
        </div>
        
        <div class="form-group">
            <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
            <textarea id="comment" rows="3"></textarea>
        </div>
        
        <div style="margin-top: 30px;">
            <button class="order-btn" style="padding: 15px;" onclick="placeOrder()">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å (–ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏)</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const currentUserId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : null;
        
        // !!! –í–ê–ñ–ù–û: –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–£ –°–°–´–õ–ö–£ –ù–ê –†–ï–ê–õ–¨–ù–´–ô URL –í–ê–®–ï–ì–û –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø APPS SCRIPT !!!
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxxJkS3rYWsZxBKjxJUvjwC2f_4Qdvonc2dkQN3I0WqqoBQ7zMGUIFAngB1RWwJUXS6/exec'; // <-- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ!
        
        let allProducts = []; 
        let currentCart = []; 
        let currentTotals = { totalItemsAmount: 0, deliveryCost: 0, finalTotal: 0 };
        let currentUserInfo = { name: '', address: '', phone: '' };


        // --- –£–¢–ò–õ–ò–¢–´ API ---

        function fetchApi(action, method = 'GET', data = null) {
            let url = 'https://script.google.com/macros/s/AKfycbyrSusIgQOUBRCaWzoeJ3en-nTeLun1zRnajAqfvmaWRB2qgLXfQvm4a9-FOl7cfPy8/exec';
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º MainButton –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            tg.MainButton.showProgress(false);

            if (method === 'GET') {
                // –î–æ–±–∞–≤–ª—è–µ–º Origin –¥–ª—è CORS (—Ö–æ—Ç—è Apps Script –Ω–µ –≤—Å–µ–≥–¥–∞ —ç—Ç–æ —á–∏—Ç–∞–µ—Ç, —ç—Ç–æ —Ö–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞)
                url += `?action=${action}&user_data=${encodeURIComponent(tg.initData)}&origin=${encodeURIComponent(window.location.origin)}`; 
            }

            const options = { method: method };
            
            if (method === 'POST' && data) {
                options.body = JSON.stringify({ ...data, action: action, userId: currentUserId });
            }
            
            return fetch(url, options)
                .then(response => {
                    tg.MainButton.hideProgress();
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
                    if (!response.ok) {
                         // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ 4xx/5xx, —á–∏—Ç–∞–µ–º —Ç–µ–ª–æ –∫–∞–∫ —Ç–µ–∫—Å—Ç (–≤–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ HTML-–æ—à–∏–±–∫–∞ Apps Script)
                        return response.text().then(text => { 
                            throw new Error(`HTTP Error: ${response.status} - ${text.substring(0, 100)}...`);
                        });
                    }
                    return response.json();
                })
                .catch(error => {
                    tg.MainButton.hideProgress();
                    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–ª—è —è—Å–Ω–æ—Å—Ç–∏ –≤—ã–≤–æ–¥–∏–º –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏.
                    alert(`–°–ï–¢–ï–í–ê–Ø –û–®–ò–ë–ö–ê API: ${error.message}`); 
                    return { status: 'error', message: `–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${error.message}` };
                });
        }

        // --- (–û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ UI –∏ –ª–æ–≥–∏–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –æ—Ç–≤–µ—Ç–µ) ---
        // showInfoAlert, showConfirmDialog, updateMainButton, showView, loadAllData, renderProducts, showAddToCartPopup, showCart, updateCartView, renderCart, updateCartItemQty, addToCart, saveCartToServer, showCheckoutForm, toggleAddressField, placeOrder, sendFinalOrder

        
        // --- –£–¢–ò–õ–ò–¢–´ UI –∏ –ù–∞–≤–∏–≥–∞—Ü–∏–∏ ---

        function showInfoAlert(message) {
            if (typeof tg.showPopup === 'function') {
                tg.showPopup({ title: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', message: message, buttons: [{ id: 'ok', type: 'ok' }] });
            } else {
                alert(message);
            }
        }

        function showConfirmDialog(message, callback) {
            if (typeof tg.showConfirm === 'function') {
                 tg.showConfirm(message, callback);
            } else {
                 callback(confirm(message));
            }
        }

        function updateMainButton() {
            if (document.getElementById('catalog-view').style.display !== 'none') {
                const total = currentTotals.finalTotal > 0 ? `${currentTotals.finalTotal} ‚ÇΩ` : '0 ‚ÇΩ';
                const text = currentCart.length === 0 
                    ? `üõí –ö–æ—Ä–∑–∏–Ω–∞ (0)` 
                    : `üõí –ö–æ—Ä–∑–∏–Ω–∞ (${currentCart.length}) ${total}`;
                tg.MainButton.setText(text).show();
                tg.MainButton.onClick(showCart);
            } else {
                tg.MainButton.hide();
            }
        }

        function showView(viewId) {
            document.getElementById('catalog-view').style.display = 'none';
            document.getElementById('cart-view').style.display = 'none';
            document.getElementById('checkout-view').style.display = 'none';
            
            const viewToShow = document.getElementById(viewId);
            if (viewToShow) {
                viewToShow.style.display = 'block';
            }
            
            updateMainButton();
        }

        // --- –õ–û–ì–ò–ö–ê –ó–ê–ì–†–£–ó–ö–ò –î–ê–ù–ù–´–• ---

        async function loadAllData() {
            try {
                const [productsData, userData, cartData] = await Promise.all([
                    fetchApi('get_products'),
                    fetchApi('get_user_info'),
                    fetchApi('get_cart')
                ]);

                if (productsData.status === 'success') {
                    allProducts = productsData.products;
                    renderProducts(allProducts);
                } else {
                    showInfoAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞: ${productsData.message}`);
                }

                if (userData.status === 'success') {
                    currentUserInfo = userData.user;
                }

                if (cartData.status === 'success') {
                    currentCart = cartData.cart;
                    currentTotals = cartData.totals;
                }
                
                showView('catalog-view');

            } catch (error) {
                alert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error); 
            }
        }
        
        function renderProducts(products) {
            const list = document.getElementById('product-list');
            list.innerHTML = '';
            
            if (products.length === 0) {
                 list.innerHTML = `<p class="loading">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>`;
                 return;
            }

            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.onclick = () => showAddToCartPopup(product);

                card.innerHTML = `
                    <img src="${product.imageUrl || 'https://via.placeholder.com/150'}" alt="${product.name}" class="product-img">
                    <div class="product-name">${product.name}</div>
                    <p class="product-price">${product.price} ‚ÇΩ</p>
                    <button class="add-btn" onclick="event.stopPropagation(); showAddToCartPopup(product)">+ –í –∫–æ—Ä–∑–∏–Ω—É</button>
                `;
                list.appendChild(card);
            });
        }
        
        function showAddToCartPopup(product) {
            const selectedOption = (product.options && product.options.length > 0) ? product.options[0] : null;

            showConfirmDialog(`–î–æ–±–∞–≤–∏—Ç—å "${product.name}" (${product.price} ‚ÇΩ) –≤ –∫–æ—Ä–∑–∏–Ω—É?` + 
                             (selectedOption ? `\n\n(–û–ø—Ü–∏—è: ${selectedOption})` : ''), 
                (isConfirmed) => {
                    if (isConfirmed) {
                        addToCart(product.id, 1, selectedOption);
                    }
                }
            );
        }


        // --- –õ–û–ì–ò–ö–ê –ö–û–†–ó–ò–ù–´ ---
        
        async function showCart() {
            await updateCartView(); 
            
            if (currentCart.length === 0) {
                 showView('catalog-view'); 
                 showInfoAlert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.');
                 return;
            }
            showView('cart-view');
        }

        async function updateCartView() {
            const data = await fetchApi('get_cart');
            if (data.status === 'success') {
                currentCart = data.cart;
                currentTotals = data.totals;
            }
            
            renderCart();
        }

        function renderCart() {
            const list = document.getElementById('cart-items-list');
            const summary = document.getElementById('cart-summary');
            const emptyMsg = document.getElementById('cart-empty-message');
            
            list.innerHTML = '';
            
            if (currentCart.length === 0) {
                emptyMsg.style.display = 'block';
                summary.style.display = 'none';
                document.getElementById('checkout-btn').disabled = true;
                return;
            }
            
            emptyMsg.style.display = 'none';
            document.getElementById('checkout-btn').disabled = false;
            
            currentCart.forEach((item) => {
                const productInfo = allProducts.find(p => p.id === item.id);
                const price = productInfo ? productInfo.price : 0;
                const name = productInfo ? productInfo.name : `–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä (${item.id})`;
                const itemTotal = price * item.qty;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item';
                itemDiv.innerHTML = `
                    <div class="cart-details">
                        <div class="cart-name">${name}</div>
                        ${item.opt ? `<div class="cart-option">${item.opt}</div>` : ''}
                        <div class="cart-price">${itemTotal} ‚ÇΩ</div>
                    </div>
                    <div class="cart-controls">
                        <button class="qty-btn" onclick="updateCartItemQty('${item.id}', '${item.opt}', -1)">‚àí</button>
                        <span class="item-quantity">${item.qty}</span>
                        <button class="qty-btn" onclick="updateCartItemQty('${item.id}', '${item.opt}', 1)">+</button>
                        <button class="qty-btn" style="background-color: #e6445b; color:white;" onclick="updateCartItemQty('${item.id}', '${item.opt}', -${item.qty})">üóëÔ∏è</button>
                    </div>
                `;
                list.appendChild(itemDiv);
            });
            
            summary.style.display = 'block';
            summary.innerHTML = `
                <div><span>–°—É–º–º–∞ —Ç–æ–≤–∞—Ä–æ–≤:</span> <span>${currentTotals.totalItemsAmount} ‚ÇΩ</span></div>
                <div><span>–î–æ—Å—Ç–∞–≤–∫–∞:</span> <span>${currentTotals.deliveryCost === 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : currentTotals.deliveryCost + ' ‚ÇΩ'}</span></div>
                <div><b>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</b> <b>${currentTotals.finalTotal} ‚ÇΩ</b></div>
            `;
            
            updateMainButton();
        }
        
        function updateCartItemQty(itemId, option, change) {
            const itemIndex = currentCart.findIndex(item => item.id === itemId && item.opt === option);
            if (itemIndex === -1) return;

            let newQty = currentCart[itemIndex].qty + change;
            
            if (newQty <= 0) {
                currentCart.splice(itemIndex, 1);
            } else {
                currentCart[itemIndex].qty = newQty;
            }

            saveCartToServer();
        }
        
        function addToCart(itemId, quantity = 1, option = null) {
             fetchApi('add_to_cart', 'POST', { itemId, quantity, option })
                 .then(data => {
                     if (data.status === 'success') {
                         currentCart = data.newCart;
                         currentTotals = data.newTotals;
                         tg.HapticFeedback.notificationOccurred('success'); 
                         showInfoAlert('–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
                         updateMainButton();
                     } else {
                         showInfoAlert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: ' + data.message);
                     }
                 });
        }
        
        function saveCartToServer() {
            fetchApi('save_cart', 'POST', { newCart: currentCart })
                .then(data => {
                    if (data.status === 'success') {
                        currentTotals = data.newTotals;
                        tg.HapticFeedback.impactOccurred('light');
                        renderCart(); 
                        updateMainButton();
                    } else {
                        showInfoAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + data.message);
                        loadAllData();
                    }
                });
        }
        
        // --- –§–û–†–ú–ê –û–§–û–†–ú–õ–ï–ù–ò–Ø ---

        async function showCheckoutForm() {
            if (currentCart.length === 0) {
                 showInfoAlert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!');
                 return;
            }
            
            const data = await fetchApi('get_user_info');
            if (data.status === 'success') {
                 currentUserInfo = data.user;
            }

            document.getElementById('name').value = currentUserInfo.name || '';
            document.getElementById('phone').value = currentUserInfo.phone || '';
            document.getElementById('address').value = currentUserInfo.address || '';
            
            document.getElementById('checkout-summary').innerHTML = `
                <div><span>–°—É–º–º–∞ —Ç–æ–≤–∞—Ä–æ–≤:</span> <span>${currentTotals.totalItemsAmount} ‚ÇΩ</span></div>
                <div><span>–î–æ—Å—Ç–∞–≤–∫–∞:</span> <span>${currentTotals.deliveryCost === 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : currentTotals.deliveryCost + ' ‚ÇΩ'}</span></div>
                <div><b>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</b> <b>${currentTotals.finalTotal} ‚ÇΩ</b></div>
            `;
            
            toggleAddressField();
            showView('checkout-view');
        }
        
        function toggleAddressField() {
            const type = document.getElementById('deliveryType').value;
            const addressGroup = document.getElementById('address-group');
            
            if (type === '–°–∞–º–æ–≤—ã–≤–æ–∑') {
                addressGroup.style.display = 'none';
                document.getElementById('address').required = false;
            } else {
                addressGroup.style.display = 'block';
                document.getElementById('address').required = true;
            }
        }

        function placeOrder() {
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const address = document.getElementById('address').value.trim();
            const comment = document.getElementById('comment').value.trim();
            const deliveryType = document.getElementById('deliveryType').value;

            if (!name || !phone) {
                showInfoAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ò–º—è –∏ –¢–µ–ª–µ—Ñ–æ–Ω.');
                return;
            }
            if (deliveryType === '–î–æ—Å—Ç–∞–≤–∫–∞' && !address) {
                showInfoAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏.');
                return;
            }

            fetchApi('update_user_info', 'POST', { name, address, phone })
                .then(data => {
                    if (data.status !== 'success') {
                        showInfoAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞.');
                        return;
                    }
                    
                    const orderDetails = { 
                        name, 
                        phone, 
                        address: deliveryType === '–°–∞–º–æ–≤—ã–≤–æ–∑' ? '–°–∞–º–æ–≤—ã–≤–æ–∑' : address,
                        comment, 
                        deliveryType 
                    };
                    
                    showConfirmDialog(`–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞–∫–∞–∑ –Ω–∞ —Å—É–º–º—É ${currentTotals.finalTotal} ‚ÇΩ. –í—ã–±—Ä–∞–Ω: ${deliveryType}.`, (isConfirmed) => {
                        if (isConfirmed) {
                             sendFinalOrder(orderDetails);
                        }
                    });
                });
        }
        
        function sendFinalOrder(orderDetails) {
             fetchApi('place_order', 'POST', { orderDetails })
                 .then(data => {
                     if (data.status === 'success') {
                         showInfoAlert(`üéâ –ó–∞–∫–∞–∑ ‚Ññ${data.orderId} –æ—Ñ–æ—Ä–º–ª–µ–Ω! –û–±—â–∞—è —Å—É–º–º–∞: ${data.finalTotal} ‚ÇΩ. –ú—ã —Å–∫–æ—Ä–æ —Å –í–∞–º–∏ —Å–≤—è–∂–µ–º—Å—è.`);
                         tg.close(); 
                     } else {
                         showInfoAlert(`üö´ –û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è: ${data.message}`);
                     }
                 });
        }


        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---

        function init() {
            if (!currentUserId) {
                document.body.innerHTML = '<h1>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞</h1><p>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞.</p>';
                alert("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞."); 
                tg.close();
                return;
            }

            tg.ready();
            tg.expand();
            tg.setHeaderColor('secondary_bg_color'); 
            
            loadAllData();
        }

        init();
    </script>
</body>
</html>

