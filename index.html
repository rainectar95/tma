<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>üåØ –ó–∞–∫–∞–∑ –õ–∞–≤–∞—à–∞ –∏ –ü—Ä–æ–¥—É–∫—Ç–æ–≤</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫ —Ç–µ–º–µ Telegram */
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f4f4f4);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-link: var(--tg-theme-link-color, #2481cc);
            --tg-button: var(--tg-theme-button-color, #50a8eb);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
        }
        body { 
            font-family: sans-serif; 
            padding: 10px; 
            background-color: var(--tg-bg); 
            color: var(--tg-text); 
            margin: 0;
        }
        h1, h2 { color: var(--tg-text); margin: 15px 0 10px 0; border-bottom: 1px solid var(--tg-secondary-bg); padding-bottom: 5px; }
        
        /* –ö–∞—Ç–∞–ª–æ–≥ */
        .product-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; padding: 5px 0; }
        .product-card { background-color: var(--tg-secondary-bg); padding: 10px; border-radius: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .product-img { width: 100%; height: 100px; object-fit: cover; border-radius: 4px; margin-bottom: 5px; }
        .product-price { font-weight: bold; color: var(--tg-link); margin-bottom: 8px; font-size: 16px; }
        .add-btn, .order-btn { background-color: var(--tg-button); color: var(--tg-button-text); border: none; padding: 8px 0; width: 100%; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* –ö–æ—Ä–∑–∏–Ω–∞ */
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed var(--tg-hint); }
        .cart-details { flex-grow: 1; padding-right: 15px; }
        .cart-name { font-weight: 600; }
        .cart-controls { display: flex; align-items: center; gap: 5px; }
        .qty-btn { background-color: var(--tg-secondary-bg); color: var(--tg-text); border: 1px solid var(--tg-hint); width: 30px; height: 30px; border-radius: 50%; font-size: 18px; line-height: 1; cursor: pointer; }
        .item-quantity { font-weight: bold; width: 25px; text-align: center; }
        .total-summary { margin-top: 20px; padding: 15px; background-color: var(--tg-secondary-bg); border-radius: 8px; }
        .total-summary div { display: flex; justify-content: space-between; margin-bottom: 5px; }
        
        /* –§–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞ */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input[type="text"], textarea, select { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid var(--tg-secondary-bg); 
            border-radius: 6px; 
            box-sizing: border-box; 
            background-color: var(--tg-bg);
            color: var(--tg-text);
        }
    </style>
</head>
<body>
    
    <div id="catalog-view" style="display: block;">
        <h1>üåØ –ö–∞—Ç–∞–ª–æ–≥ –ü—Ä–æ–¥—É–∫—Ç–æ–≤</h1>
        <div id="product-list" class="product-list">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞...</div>
        </div>
    </div>
    
    <div id="cart-view" style="display: none;">
        <button class="order-btn" style="background-color: transparent; color: var(--tg-link);" onclick="showView('catalog-view')">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–∞–ª–æ–≥—É</button>
        <h2>üõí –í–∞—à–∞ –ö–æ—Ä–∑–∏–Ω–∞</h2>
        <div id="cart-items-list"></div>
        <div id="cart-empty-message" style="text-align: center; color: var(--tg-hint); margin-top: 20px; display: none;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.</div>
        <div id="cart-summary" class="total-summary"></div>
        <div style="margin-top: 20px;">
            <button id="checkout-btn" class="order-btn" style="padding: 15px;" onclick="showCheckoutForm()">‚û°Ô∏è –û—Ñ–æ—Ä–º–∏—Ç—å –ó–∞–∫–∞–∑</button>
        </div>
    </div>
    
    <div id="checkout-view" style="display: none;">
        <button class="order-btn" style="background-color: transparent; color: var(--tg-link);" onclick="showView('cart-view')">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –∫–æ—Ä–∑–∏–Ω–µ</button>
        <h2>üìÑ –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h2>
        
        <div class="total-summary" id="checkout-summary"></div>
        
        <div class="form-group">
            <label for="deliveryType">–¢–∏–ø –ø–æ–ª—É—á–µ–Ω–∏—è:</label>
            <select id="deliveryType" onchange="toggleAddressField()" style="padding: 10px;">
                <option value="–î–æ—Å—Ç–∞–≤–∫–∞">–î–æ—Å—Ç–∞–≤–∫–∞ (–ö—É—Ä—å–µ—Ä–æ–º)</option>
                <option value="–°–∞–º–æ–≤—ã–≤–æ–∑">–°–∞–º–æ–≤—ã–≤–æ–∑ (–ò–∑ —Ü–µ—Ö–∞)</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="name">–í–∞—à–µ –ò–º—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
            <input type="text" id="name" required>
        </div>
        
        <div class="form-group">
            <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
            <input type="text" id="phone" required placeholder="+7 (XXX) XXX XX XX">
        </div>
        
        <div class="form-group" id="address-group">
            <label for="address">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
            <input type="text" id="address" required placeholder="–£–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞">
        </div>
        
        <div class="form-group">
            <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
            <textarea id="comment" rows="3"></textarea>
        </div>
        
        <div style="margin-top: 30px;">
            <button class="order-btn" style="padding: 15px;" onclick="placeOrder()">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å (–ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏)</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const currentUserId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : null;
        const APPS_SCRIPT_URL = '<?= ScriptApp.get=' + 'WebAppUrl() ?>';
        
        let allProducts = []; 
        let currentCart = []; 
        let currentTotals = { totalItemsAmount: 0, deliveryCost: 0, finalTotal: 0 };
        let currentUserInfo = { name: '', address: '', phone: '' };


        // --- –£–¢–ò–õ–ò–¢–´ API ---

        function fetchApi(action, method = 'GET', data = null) {
            let url = APPS_SCRIPT_URL;
            tg.showProgress(); // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏

            if (method === 'GET') {
                url += `?action=${action}&user_data=${encodeURIComponent(tg.initData)}`; 
            }

            const options = { method: method };
            
            if (method === 'POST' && data) {
                options.body = JSON.stringify({ ...data, action: action, userId: currentUserId });
            }
            
            return fetch(url, options)
                .then(response => {
                    tg.hideProgress();
                    return response.json();
                })
                .catch(error => {
                    tg.hideProgress();
                    tg.showAlert(`–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${error.message}`);
                    return { status: 'error', message: '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞' };
                });
        }

        // --- –£–¢–ò–õ–ò–¢–´ UI –∏ –ù–∞–≤–∏–≥–∞—Ü–∏–∏ ---

        function showView(viewId) {
            document.getElementById('catalog-view').style.display = 'none';
            document.getElementById('cart-view').style.display = 'none';
            document.getElementById('checkout-view').style.display = 'none';
            
            const viewToShow = document.getElementById(viewId);
            if (viewToShow) {
                viewToShow.style.display = 'block';
            }
            
            if (viewId === 'catalog-view') {
                tg.MainButton.setText(`üõí –ö–æ—Ä–∑–∏–Ω–∞ (${currentCart.length}) ${currentTotals.finalTotal} ‚ÇΩ`).show();
                tg.MainButton.onClick(showCart);
            } else {
                tg.MainButton.hide();
            }
        }

        // --- –õ–û–ì–ò–ö–ê –ó–ê–ì–†–£–ó–ö–ò –î–ê–ù–ù–´–• ---

        async function loadAllData() {
            try {
                const [productsData, userData, cartData] = await Promise.all([
                    fetchApi('get_products'),
                    fetchApi('get_user_info'),
                    fetchApi('get_cart')
                ]);

                if (productsData.status === 'success') {
                    allProducts = productsData.products;
                    renderProducts(allProducts);
                } else {
                    tg.showAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞: ${productsData.message}`);
                }

                if (userData.status === 'success') {
                    currentUserInfo = userData.user;
                }

                if (cartData.status === 'success') {
                    currentCart = cartData.cart;
                    currentTotals = cartData.totals;
                }
                
                showView('catalog-view');

            } catch (error) {
                tg.showAlert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error);
            }
        }
        
        function renderProducts(products) {
            const list = document.getElementById('product-list');
            list.innerHTML = '';
            
            if (products.length === 0) {
                 list.innerHTML = `<p class="loading">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>`;
                 return;
            }

            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.onclick = () => showAddToCartPopup(product);

                card.innerHTML = `
                    <img src="${product.imageUrl || 'https://via.placeholder.com/150'}" alt="${product.name}" class="product-img">
                    <div class="product-name">${product.name}</div>
                    <p class="product-price">${product.price} ‚ÇΩ</p>
                    <button class="add-btn" onclick="event.stopPropagation(); showAddToCartPopup(product)">+ –í –∫–æ—Ä–∑–∏–Ω—É</button>
                `;
                list.appendChild(card);
            });
        }
        
        function showAddToCartPopup(product) {
            let optionsHtml = '';
            let selectedOption = null;

            if (product.options && product.options.length > 0) {
                optionsHtml = product.options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                selectedOption = product.options[0]; // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –æ–ø—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            }
            
            tg.showPopup({
                title: product.name,
                message: `${product.description || ''}\n\n–¶–µ–Ω–∞: ${product.price} ‚ÇΩ`,
                buttons: [
                    { id: 'add', type: 'default', text: `–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É` },
                    { id: 'close', type: 'cancel', text: '–û—Ç–º–µ–Ω–∞' }
                ]
            }, (buttonId) => {
                if (buttonId === 'add') {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É, —Ç–∞–∫ –∫–∞–∫ showPopup –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—Å—Ç–∞–≤–∏—Ç—å input/select.
                    addToCart(product.id, 1, selectedOption);
                }
            });
        }


        // --- –õ–û–ì–ò–ö–ê –ö–û–†–ó–ò–ù–´ ---
        
        async function showCart() {
            await updateCartView(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ—Ä–∑–∏–Ω—É –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º
            showView('cart-view');
        }

        async function updateCartView() {
            const data = await fetchApi('get_cart');
            if (data.status === 'success') {
                currentCart = data.cart;
                currentTotals = data.totals;
            } else {
                 currentCart = [];
            }
            
            renderCart();
        }

        function renderCart() {
            const list = document.getElementById('cart-items-list');
            const summary = document.getElementById('cart-summary');
            const emptyMsg = document.getElementById('cart-empty-message');
            
            list.innerHTML = '';
            
            if (currentCart.length === 0) {
                emptyMsg.style.display = 'block';
                summary.style.display = 'none';
                document.getElementById('checkout-btn').disabled = true;
                showView('catalog-view'); // –í–µ—Ä–Ω—É—Ç—å –≤ –∫–∞—Ç–∞–ª–æ–≥, –µ—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞
                return;
            }
            
            emptyMsg.style.display = 'none';
            document.getElementById('checkout-btn').disabled = false;
            
            currentCart.forEach((item, index) => {
                const productInfo = allProducts.find(p => p.id === item.id);
                const price = productInfo ? productInfo.price : 0;
                const name = productInfo ? productInfo.name : `–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä (${item.id})`;
                const itemTotal = price * item.qty;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item';
                itemDiv.innerHTML = `
                    <div class="cart-details">
                        <div class="cart-name">${name}</div>
                        ${item.opt ? `<div class="cart-option">${item.opt}</div>` : ''}
                        <div class="cart-price">${itemTotal} ‚ÇΩ</div>
                    </div>
                    <div class="cart-controls">
                        <button class="qty-btn" onclick="updateCartItemQty('${item.id}', '${item.opt}', -1)">‚àí</button>
                        <span class="item-quantity">${item.qty}</span>
                        <button class="qty-btn" onclick="updateCartItemQty('${item.id}', '${item.opt}', 1)">+</button>
                        <button class="qty-btn" style="background-color: #e6445b; color:white;" onclick="updateCartItemQty('${item.id}', '${item.opt}', -${item.qty})">üóëÔ∏è</button>
                    </div>
                `;
                list.appendChild(itemDiv);
            });
            
            summary.style.display = 'block';
            summary.innerHTML = `
                <div><span>–°—É–º–º–∞ —Ç–æ–≤–∞—Ä–æ–≤:</span> <span>${currentTotals.totalItemsAmount} ‚ÇΩ</span></div>
                <div><span>–î–æ—Å—Ç–∞–≤–∫–∞:</span> <span>${currentTotals.deliveryCost === 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : currentTotals.deliveryCost + ' ‚ÇΩ'}</span></div>
                <div><b>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</b> <b>${currentTotals.finalTotal} ‚ÇΩ</b></div>
            `;
            
            tg.MainButton.setText(`üõí –ö–æ—Ä–∑–∏–Ω–∞ (${currentCart.length}) ${currentTotals.finalTotal} ‚ÇΩ`).show();
        }
        
        function updateCartItemQty(itemId, option, change) {
            const itemIndex = currentCart.findIndex(item => item.id === itemId && item.opt === option);
            if (itemIndex === -1) return;

            let newQty = currentCart[itemIndex].qty + change;
            
            if (newQty <= 0) {
                currentCart.splice(itemIndex, 1);
            } else {
                currentCart[itemIndex].qty = newQty;
            }

            saveCartToServer();
        }
        
        function addToCart(itemId, quantity = 1, option = null) {
             fetchApi('add_to_cart', 'POST', { itemId, quantity, option })
                 .then(data => {
                     if (data.status === 'success') {
                         currentCart = data.newCart;
                         currentTotals = calculateCartTotals(currentCart); // –ì—Ä—É–±—ã–π —Ä–∞—Å—á–µ—Ç –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ
                         tg.HapticFeedback.notificationOccurred('success'); 
                         tg.showPopup({ title: '–ì–æ—Ç–æ–≤–æ', message: '–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!' });
                         renderCart(); // –û–±–Ω–æ–≤–ª—è–µ–º UI
                         showView('catalog-view');
                     } else {
                         tg.showAlert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: ' + data.message);
                     }
                 });
        }
        
        function saveCartToServer() {
            fetchApi('save_cart', 'POST', { newCart: currentCart })
                .then(data => {
                    if (data.status === 'success') {
                        tg.HapticFeedback.impactOccurred('light');
                        updateCartView(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö totals
                    } else {
                        tg.showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + data.message);
                    }
                });
        }
        
        // --- –§–û–†–ú–ê –û–§–û–†–ú–õ–ï–ù–ò–Ø ---

        function showCheckoutForm() {
            if (currentCart.length === 0) {
                 tg.showAlert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!');
                 return;
            }
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ñ–æ—Ä–º—É
            document.getElementById('name').value = currentUserInfo.name || '';
            document.getElementById('phone').value = currentUserInfo.phone || '';
            document.getElementById('address').value = currentUserInfo.address || '';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É –≤ —Ñ–æ—Ä–º–µ
            document.getElementById('checkout-summary').innerHTML = document.getElementById('cart-summary').innerHTML;
            
            toggleAddressField();
            showView('checkout-view');
        }
        
        function toggleAddressField() {
            const type = document.getElementById('deliveryType').value;
            const addressGroup = document.getElementById('address-group');
            
            if (type === '–°–∞–º–æ–≤—ã–≤–æ–∑') {
                addressGroup.style.display = 'none';
                document.getElementById('address').required = false;
            } else {
                addressGroup.style.display = 'block';
                document.getElementById('address').required = true;
            }
        }

        function placeOrder() {
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const address = document.getElementById('address').value.trim();
            const comment = document.getElementById('comment').value.trim();
            const deliveryType = document.getElementById('deliveryType').value;

            if (!name || !phone) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ò–º—è –∏ –¢–µ–ª–µ—Ñ–æ–Ω.');
                return;
            }
            if (deliveryType === '–î–æ—Å—Ç–∞–≤–∫–∞' && !address) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏.');
                return;
            }

            // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            fetchApi('update_user_info', 'POST', { name, address, phone })
                .then(data => {
                    if (data.status !== 'success') {
                        tg.showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞.');
                        return;
                    }
                    
                    // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑
                    const orderDetails = { 
                        name, 
                        phone, 
                        address: deliveryType === '–°–∞–º–æ–≤—ã–≤–æ–∑' ? '–°–∞–º–æ–≤—ã–≤–æ–∑' : address,
                        comment, 
                        deliveryType 
                    };
                    
                    tg.showConfirm(`–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞–∫–∞–∑ –Ω–∞ —Å—É–º–º—É ${currentTotals.finalTotal} ‚ÇΩ. –í—ã–±—Ä–∞–Ω: ${deliveryType}.`, (isConfirmed) => {
                        if (isConfirmed) {
                             sendFinalOrder(orderDetails);
                        }
                    });
                });
        }
        
        function sendFinalOrder(orderDetails) {
             fetchApi('place_order', 'POST', { orderDetails })
                 .then(data => {
                     if (data.status === 'success') {
                         tg.showAlert(`üéâ –ó–∞–∫–∞–∑ ‚Ññ${data.orderId} –æ—Ñ–æ—Ä–º–ª–µ–Ω! –û–±—â–∞—è —Å—É–º–º–∞: ${currentTotals.finalTotal} ‚ÇΩ.`);
                         tg.MainButton.hide();
                         tg.close(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º Mini App
                     } else {
                         tg.showAlert(`üö´ –û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è: ${data.message}`);
                     }
                 });
        }

        // --- –£–¢–ò–õ–ò–¢–ê –†–ê–°–ß–ï–¢–ê –ù–ê –§–†–û–ù–¢–ï (–ì–†–£–ë–ê–Ø) ---
        function calculateCartTotals(cart) {
            let total = 0;
            cart.forEach(item => {
                const product = allProducts.find(p => p.id === item.id);
                if (product) {
                    total += product.price * item.qty;
                }
            });
            // –ù–∞ —Ñ—Ä–æ–Ω—Ç–µ –º—ã –Ω–µ –∑–Ω–∞–µ–º BASE_DELIVERY_COST, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É
            return { totalItemsAmount: total, deliveryCost: 0, finalTotal: total };
        }


        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---

        function init() {
            if (!currentUserId) {
                tg.showAlert("–û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞.");
                tg.close();
                return;
            }

            tg.ready();
            tg.expand();
            tg.setHeaderColor('secondary_bg_color'); 
            
            loadAllData();
        }

        init();
    </script>
</body>
</html>
